<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>shared-horses-data editor</title>
  <style>
    :root {
      --bg: #0f1219;
      --panel: #171d28;
      --line: #2a3447;
      --text: #e8edf7;
      --muted: #9ca8bd;
      --accent: #6ed0ff;
      --danger: #ff6e86;
      --ok: #8ee090;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 15% -10%, #21324f, var(--bg));
    }
    .wrap {
      width: min(1400px, 97vw);
      margin: 16px auto 24px;
    }
    h1 {
      margin: 0 0 10px;
      font-size: clamp(20px, 2.8vw, 30px);
      letter-spacing: .02em;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: color-mix(in oklab, var(--panel), black 12%);
      margin-bottom: 10px;
    }
    button {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #111722;
      color: var(--text);
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
    }
    button:hover { border-color: #46618b; }
    .primary { background: #17304d; border-color: #355c8f; }
    .danger { background: #3b1c27; border-color: #7c3044; }
    #q {
      min-width: 260px;
      flex: 1;
      max-width: 560px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #0f141e;
      color: var(--text);
      padding: 8px 10px;
    }
    .meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 8px 0 10px;
    }
    .chip {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 5px 9px;
      background: #172235;
      color: #c4d2eb;
      font-size: 12px;
    }
    .chip.ok { border-color: #2d5f3f; background: #173025; color: #b6f0c5; }
    .chip.warn { border-color: #7b5a2f; background: #382b16; color: #f4d9a7; }

    .table-wrap {
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: auto;
      background: rgba(11, 14, 20, .76);
      max-height: 75vh;
    }
    table {
      border-collapse: collapse;
      min-width: 1500px;
      width: 100%;
    }
    th, td {
      border-bottom: 1px solid #212a39;
      border-right: 1px solid #1d2634;
      padding: 6px;
      vertical-align: top;
    }
    th {
      position: sticky;
      top: 0;
      background: #131b29;
      z-index: 2;
      font-size: 12px;
      color: #b7c6e2;
      white-space: nowrap;
    }
    td { min-width: 140px; }
    td.actions {
      min-width: 70px;
      text-align: center;
      position: sticky;
      left: 0;
      background: #101722;
      z-index: 1;
    }
    th.actions {
      left: 0;
      z-index: 3;
      background: #121b2a;
    }
    td.cell-readonly {
      color: #9fb6d8;
      background: rgba(98, 131, 179, 0.08);
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(5, 9, 14, 0.72);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 40;
    }
    .modal-backdrop.open { display: flex; }
    .modal {
      width: min(760px, 100%);
      max-height: 90vh;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #101722;
      padding: 14px;
      box-shadow: 0 20px 70px rgba(0, 0, 0, 0.6);
    }
    .modal h2 {
      margin: 0 0 12px;
      font-size: 20px;
    }
    .form-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr 1fr;
    }
    .form-item {
      display: grid;
      gap: 4px;
    }
    .form-item.wide { grid-column: 1 / -1; }
    .form-item label {
      font-size: 12px;
      color: #b7c6e2;
    }
    .form-item input,
    .form-item select {
      width: 100%;
      border: 1px solid #283247;
      border-radius: 8px;
      background: #0d131e;
      color: var(--text);
      padding: 8px 9px;
      font-size: 13px;
      min-height: 34px;
    }
    .form-item .readonly-value {
      border: 1px solid #32415a;
      border-radius: 8px;
      background: #151f2e;
      color: #b6c6df;
      padding: 8px 9px;
      font-size: 13px;
      min-height: 34px;
      word-break: break-all;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 14px;
    }
    .muted { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>shared-horses-data editor</h1>

    <section class="toolbar">
      <button id="reload" type="button">再読込</button>
      <button id="add-row" class="primary" type="button">行を追加</button>
      <button id="export" class="primary" type="button">JSONエクスポート</button>
      <input id="q" type="search" placeholder="検索（name, horse_id, sire, dam, trainer...）" />
    </section>

    <div class="meta" id="meta"></div>
    <p class="muted">注意: この画面の編集はブラウザ内のみです。保存は「JSONエクスポート」で行い、`horses.json` を置き換えてください。</p>

    <section class="table-wrap">
      <table>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </main>
  <div id="edit-modal-wrap" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
    <div class="modal">
      <h2 id="edit-modal-title">馬情報を編集</h2>
      <form id="edit-form">
        <div id="edit-form-grid" class="form-grid"></div>
        <div class="modal-actions">
          <button id="cancel-edit" type="button">キャンセル</button>
          <button class="primary" type="submit">保存</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const FIELD_ORDER = [
      'slug', 'name', 'sire', 'dam', 'damsire',
      'birth', 'price', 'training_center', 'trainer', 'farm',
      'height_cm', 'girth_cm', 'cannon_cm', 'weight_kg',
      'club', 'clubPage', 'local_id', 'career_status',
      'jra_id', 'jbis_id', 'studbook_num', 'tab',
      'stable', 'netkeiba_horse_id', 'horse_id'
    ];
    const NUMERIC_FIELDS = new Set(['height_cm', 'girth_cm', 'cannon_cm', 'weight_kg', 'tab']);
    const NON_EDITABLE_FIELDS = new Set(['stable', 'netkeiba_horse_id', 'horse_id']);
    const TRAINING_CENTER_OPTIONS_BASE = ['', '美浦', '栗東', '地方', '海外'];
    const CLUB_OPTIONS_BASE = ['', 'carrot', 'silk', 'tokyo', 'win', 'union', 'normandy'];
    const CAREER_STATUS_OPTIONS_BASE = ['', 'active', 'retired'];

    const state = {
      sourceKind: 'array',
      horses: [],
      columns: [],
      q: '',
      dirty: false,
      editingRowIndex: null,
    };

    const $ = (s) => document.querySelector(s);

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function displayValue(v) {
      if (v === null || v === undefined) return '';
      return String(v);
    }

    function parseInput(field, raw) {
      const trimmed = raw.trim();
      if (NUMERIC_FIELDS.has(field)) {
        if (trimmed === '') return null;
        const n = Number(trimmed);
        return Number.isFinite(n) ? n : trimmed;
      }
      return trimmed;
    }

    function mergedOptions(baseOptions, dataValues, currentValue) {
      const set = new Set(baseOptions);
      dataValues.forEach((v) => set.add(displayValue(v).trim()));
      set.add(displayValue(currentValue).trim());
      return [...set].filter(v => v !== '').sort((a, b) => a.localeCompare(b, 'ja'));
    }

    function buildLegacyFields(src) {
      const trainingCenter = displayValue(src.training_center).trim();
      const trainer = displayValue(src.trainer).trim();
      const studbookNum = displayValue(src.studbook_num).trim();
      const club = displayValue(src.club).trim();
      const localId = displayValue(src.local_id).trim();

      const stable = trainingCenter && trainer
        ? `${trainingCenter}　${trainer}`
        : (trainingCenter || trainer);
      const horseId = club && localId
        ? `${club}_${localId}`
        : (club ? `${club}_` : (localId ? `_${localId}` : ''));

      return {
        stable,
        netkeiba_horse_id: studbookNum,
        horse_id: horseId,
      };
    }

    function formControl(name) {
      const form = $('#edit-form');
      return form?.elements?.namedItem(name) || null;
    }

    function formValue(name) {
      const control = formControl(name);
      if (!control || !('value' in control)) return '';
      return String(control.value || '').trim();
    }

    function updateReadonlyField(field, value) {
      const target = document.querySelector(`[data-readonly-field="${field}"]`);
      if (!target) return;
      if (!value) {
        target.innerHTML = '&nbsp;';
        return;
      }
      target.textContent = value;
    }

    function refreshLegacyPreviewFromForm() {
      const legacy = buildLegacyFields({
        training_center: formValue('training_center'),
        trainer: formValue('trainer'),
        studbook_num: formValue('studbook_num'),
        club: formValue('club'),
        local_id: formValue('local_id'),
      });
      updateReadonlyField('stable', legacy.stable);
      updateReadonlyField('netkeiba_horse_id', legacy.netkeiba_horse_id);
      updateReadonlyField('horse_id', legacy.horse_id);
    }

    function deriveColumns(horses) {
      const set = new Set();
      horses.forEach(h => Object.keys(h).forEach(k => set.add(k)));
      const others = [...set].filter(k => !FIELD_ORDER.includes(k)).sort();
      return [...FIELD_ORDER.filter(k => set.has(k)), ...others];
    }

    function filteredRows() {
      const q = state.q.trim().toLowerCase();
      if (!q) return state.horses;
      return state.horses.filter(h =>
        state.columns.some(c => String(h[c] ?? '').toLowerCase().includes(q))
      );
    }

    function renderMeta(viewRows) {
      const dirty = state.dirty
        ? '<span class="chip warn">未保存の変更あり</span>'
        : '<span class="chip ok">保存済み状態</span>';
      const chips = [
        `<span class="chip">表示: ${viewRows.length} / 全体: ${state.horses.length}</span>`,
        `<span class="chip">項目数: ${state.columns.length}</span>`,
        dirty,
      ];
      $('#meta').innerHTML = chips.join('');
    }

    function renderTable() {
      const rows = filteredRows();
      const thead = $('#thead');
      const tbody = $('#tbody');

      const headCols = state.columns.map(c => `<th>${escapeHtml(c)}</th>`).join('');
      thead.innerHTML = `<tr><th class="actions">操作</th>${headCols}</tr>`;

      tbody.innerHTML = rows.map((row) => {
        const realIndex = state.horses.indexOf(row);
        const cols = state.columns.map((c) => {
          const value = escapeHtml(displayValue(row[c]));
          const cellClass = NON_EDITABLE_FIELDS.has(c) ? ' class="cell-readonly"' : '';
          return `<td${cellClass}>${value}</td>`;
        }).join('');

        return `
          <tr>
            <td class="actions">
              <button type="button" data-edit="${realIndex}">編集</button>
              <button class="danger" type="button" data-del="${realIndex}">削除</button>
            </td>
            ${cols}
          </tr>
        `;
      }).join('');

      renderMeta(rows);
    }

    function markDirty() {
      state.dirty = true;
    }

    function addRow() {
      const row = {};
      const allColumns = state.columns.length > 0 ? state.columns : FIELD_ORDER;
      allColumns.forEach((c) => { row[c] = NUMERIC_FIELDS.has(c) ? null : ''; });
      state.horses.unshift(row);
      markDirty();
      renderTable();
    }

    function deleteRow(index) {
      const row = state.horses[index];
      const label = row?.name || row?.horse_id || `row:${index}`;
      if (!confirm(`削除しますか？\n${label}`)) return;
      state.horses.splice(index, 1);
      markDirty();
      renderTable();
    }

    function toExportDoc() {
      if (state.sourceKind === 'array') return state.horses;
      return { horses: state.horses };
    }

    function normalizeRowOrder(row) {
      const out = {};
      state.columns.forEach((k) => {
        if (Object.prototype.hasOwnProperty.call(row, k)) {
          out[k] = row[k];
          return;
        }
        out[k] = NUMERIC_FIELDS.has(k) ? null : '';
      });
      Object.keys(row).forEach((k) => {
        if (!Object.prototype.hasOwnProperty.call(out, k)) out[k] = row[k];
      });
      return out;
    }

    function exportJson() {
      state.horses = state.horses.map(normalizeRowOrder);
      const doc = toExportDoc();
      const blob = new Blob([`${JSON.stringify(doc, null, 2)}\n`], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'horses.json';
      a.click();
      URL.revokeObjectURL(url);
      state.dirty = false;
      renderTable();
    }

    function isWideField(field) {
      return ['clubPage', 'jra_id', 'jbis_id', 'netkeiba_horse_id', 'horse_id', 'slug', 'name'].includes(field);
    }

    function openEditModal(rowIndex) {
      const row = state.horses[rowIndex];
      if (!row) return;
      state.editingRowIndex = rowIndex;
      $('#edit-modal-title').textContent = `馬情報を編集: ${row.name || row.horse_id || row.slug || `row:${rowIndex}`}`;

      const html = state.columns.map((field) => {
        const label = escapeHtml(field);
        const value = escapeHtml(displayValue(row[field]));
        const wide = isWideField(field) ? ' wide' : '';
        if (NON_EDITABLE_FIELDS.has(field)) {
          return `
            <div class="form-item${wide}">
              <label>${label}（編集不可）</label>
              <div class="readonly-value" data-readonly-field="${label}">${value || '&nbsp;'}</div>
            </div>
          `;
        }
        if (field === 'training_center') {
          const options = mergedOptions(
            TRAINING_CENTER_OPTIONS_BASE,
            state.horses.map(h => h.training_center),
            row[field]
          ).map((opt) => {
            const selected = (displayValue(row[field]) === opt) ? ' selected' : '';
            return `<option value="${escapeHtml(opt)}"${selected}>${escapeHtml(opt)}</option>`;
          }).join('');
          const emptySelected = displayValue(row[field]) === '' ? ' selected' : '';
          return `
            <div class="form-item${wide}">
              <label>${label}</label>
              <select name="${escapeHtml(field)}">
                <option value=""${emptySelected}>未設定</option>
                ${options}
              </select>
            </div>
          `;
        }
        if (field === 'club') {
          const options = mergedOptions(
            CLUB_OPTIONS_BASE,
            state.horses.map(h => h.club),
            row[field]
          ).map((opt) => {
            const selected = (displayValue(row[field]) === opt) ? ' selected' : '';
            return `<option value="${escapeHtml(opt)}"${selected}>${escapeHtml(opt)}</option>`;
          }).join('');
          const emptySelected = displayValue(row[field]) === '' ? ' selected' : '';
          return `
            <div class="form-item${wide}">
              <label>${label}</label>
              <select name="${escapeHtml(field)}">
                <option value=""${emptySelected}>未設定</option>
                ${options}
              </select>
            </div>
          `;
        }
        if (field === 'career_status') {
          const options = mergedOptions(
            CAREER_STATUS_OPTIONS_BASE,
            state.horses.map(h => h.career_status),
            row[field]
          ).map((opt) => {
            const selected = (displayValue(row[field]) === opt) ? ' selected' : '';
            return `<option value="${escapeHtml(opt)}"${selected}>${escapeHtml(opt)}</option>`;
          }).join('');
          const emptySelected = displayValue(row[field]) === '' ? ' selected' : '';
          return `
            <div class="form-item${wide}">
              <label>${label}</label>
              <select name="${escapeHtml(field)}">
                <option value=""${emptySelected}>未設定</option>
                ${options}
              </select>
            </div>
          `;
        }
        return `
          <div class="form-item${wide}">
            <label>${label}</label>
            <input name="${escapeHtml(field)}" value="${value}" />
          </div>
        `;
      }).join('');

      $('#edit-form-grid').innerHTML = html;
      refreshLegacyPreviewFromForm();
      $('#edit-modal-wrap').classList.add('open');
    }

    function closeEditModal() {
      state.editingRowIndex = null;
      $('#edit-modal-wrap').classList.remove('open');
      $('#edit-form-grid').innerHTML = '';
    }

    function saveEditModal() {
      const rowIndex = state.editingRowIndex;
      if (!Number.isInteger(rowIndex)) return;
      const row = state.horses[rowIndex];
      if (!row) return;
      const formData = new FormData($('#edit-form'));
      state.columns.forEach((field) => {
        if (NON_EDITABLE_FIELDS.has(field)) return;
        const raw = formData.get(field);
        row[field] = parseInput(field, raw == null ? '' : String(raw));
      });
      Object.assign(row, buildLegacyFields(row));
      markDirty();
      closeEditModal();
      renderTable();
    }

    function bindEvents() {
      $('#q').addEventListener('input', (e) => {
        state.q = e.target.value;
        renderTable();
      });

      $('#reload').addEventListener('click', () => {
        if (state.dirty && !confirm('未保存の変更があります。再読込しますか？')) return;
        boot();
      });

      $('#add-row').addEventListener('click', addRow);
      $('#export').addEventListener('click', exportJson);

      $('#tbody').addEventListener('click', (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        const edit = t.getAttribute('data-edit');
        if (edit != null) {
          openEditModal(Number(edit));
          return;
        }
        const del = t.getAttribute('data-del');
        if (del == null) return;
        deleteRow(Number(del));
      });

      $('#cancel-edit').addEventListener('click', closeEditModal);
      $('#edit-form').addEventListener('submit', (e) => {
        e.preventDefault();
        saveEditModal();
      });
      $('#edit-form').addEventListener('input', refreshLegacyPreviewFromForm);
      $('#edit-form').addEventListener('change', refreshLegacyPreviewFromForm);
      $('#edit-modal-wrap').addEventListener('click', (e) => {
        if (e.target === $('#edit-modal-wrap')) closeEditModal();
      });
    }

    async function loadHorses() {
      const res = await fetch('./horses.json', { cache: 'no-store' });
      if (!res.ok) throw new Error(`horses.json: ${res.status}`);
      const doc = await res.json();
      if (Array.isArray(doc)) {
        state.sourceKind = 'array';
        return doc;
      }
      if (doc && Array.isArray(doc.horses)) {
        state.sourceKind = 'object';
        return doc.horses;
      }
      throw new Error('horses.json の形式が不正です');
    }

    async function boot() {
      try {
        state.horses = await loadHorses();
        state.columns = deriveColumns(state.horses);
        state.q = '';
        state.dirty = false;
        $('#q').value = '';
        renderTable();
      } catch (err) {
        $('#thead').innerHTML = '';
        $('#tbody').innerHTML = `<tr><td>読み込み失敗: ${escapeHtml(String(err.message || err))}</td></tr>`;
      }
    }

    bindEvents();
    boot();
  </script>
</body>
</html>
